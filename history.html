<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PupilCheck - Patient History</title>
  <meta name="theme-color" content="#e94560">
  <meta name="description" content="PupilCheck patient history - view measurements, trends, and clinical data">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PupilCheck">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/history.css">
</head>
<body>

  <!-- ================================================================
       HEADER
       ================================================================ -->
  <header class="header" role="banner">
    <h1>PupilCheck</h1>
    <div class="subtitle" data-i18n="history.title">Patient History</div>
  </header>

  <!-- ================================================================
       MAIN CONTENT
       ================================================================ -->
  <main class="screen active" role="main" aria-label="Patient History" style="display:block">

    <!-- Navigation bar -->
    <nav class="history-nav" aria-label="History navigation">
      <a href="index.html" class="btn btn-sm btn-secondary history-nav-back" aria-label="Back to home">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align:-2px;margin-right:4px">
          <path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/>
        </svg>
        <span data-i18n="history.home">Home</span>
      </a>
      <div class="history-nav-actions">
        <button class="btn btn-sm btn-secondary" onclick="History.showImportDialog()" aria-label="Import patient data">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align:-2px;margin-right:4px">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span data-i18n="history.import">Import</span>
        </button>
        <button class="btn btn-sm btn-secondary" onclick="History.exportAll()" aria-label="Export all patient data">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align:-2px;margin-right:4px">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <span data-i18n="history.exportAll">Export All</span>
        </button>
        <button class="btn btn-sm btn-primary" onclick="History.createPatient()" aria-label="Add new patient">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align:-2px;margin-right:4px">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          <span data-i18n="history.addPatient">Patient</span>
        </button>
      </div>
    </nav>

    <!-- Storage warning -->
    <div id="storageWarning" class="tip-box" style="display:none" role="alert" aria-live="polite"></div>

    <!-- Summary stats -->
    <div class="history-stats" id="historyStats" aria-label="Summary statistics"></div>

    <!-- Search -->
    <div class="search-bar">
      <svg class="search-bar-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input type="text" id="searchInput" placeholder="Search patients..." oninput="History.onSearch()" aria-label="Search patients" data-i18n="history.searchPlaceholder">
      <button class="search-bar-clear" id="searchClear" onclick="History.clearSearch()" aria-label="Clear search" style="display:none">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Sort controls -->
    <div class="history-sort" role="group" aria-label="Sort patients">
      <button class="sort-btn active" data-sort="newest" onclick="History.setSort('newest')" aria-pressed="true">
        <span data-i18n="history.sortNewest">Newest</span>
      </button>
      <button class="sort-btn" data-sort="oldest" onclick="History.setSort('oldest')" aria-pressed="false">
        <span data-i18n="history.sortOldest">Oldest</span>
      </button>
      <button class="sort-btn" data-sort="name" onclick="History.setSort('name')" aria-pressed="false">
        <span data-i18n="history.sortName">A-Z</span>
      </button>
      <button class="sort-btn" data-sort="most" onclick="History.setSort('most')" aria-pressed="false">
        <span data-i18n="history.sortMost">Most</span>
      </button>
    </div>

    <!-- Patient list -->
    <div id="patientList" aria-live="polite" role="list"></div>

    <!-- Empty state -->
    <div id="emptyState" class="empty-state" style="display:none">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
        <rect x="9" y="3" width="6" height="4" rx="1"/>
        <line x1="9" y1="12" x2="15" y2="12"/>
        <line x1="9" y1="16" x2="13" y2="16"/>
      </svg>
      <div class="empty-state-title" data-i18n="history.noPatients">No patients yet</div>
      <div class="empty-state-desc" data-i18n="history.noPatients.desc">Add a patient to start tracking measurements over time.</div>
      <button class="btn btn-primary empty-state-btn" onclick="History.createPatient()" aria-label="Add first patient">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align:-2px;margin-right:6px">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <span data-i18n="history.addFirstPatient">Add First Patient</span>
      </button>
    </div>

    <!-- No search results state -->
    <div id="noResultsState" class="empty-state" style="display:none">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
      </svg>
      <div class="empty-state-title" data-i18n="history.noResults">No matching patients</div>
      <div class="empty-state-desc" data-i18n="history.noResults.desc">Try a different search term.</div>
    </div>

  </main>

  <!-- ================================================================
       PATIENT DETAIL MODAL
       ================================================================ -->
  <div class="modal-overlay" id="patientModal" style="display:none" role="dialog" aria-label="Patient details" aria-modal="true">
    <div class="modal modal-large">
      <div class="modal-header">
        <h2 id="patientModalTitle">Patient</h2>
        <button class="modal-close" onclick="History.closePatientModal()" aria-label="Close patient details">&times;</button>
      </div>
      <div class="modal-body" id="patientModalBody"></div>
    </div>
  </div>

  <!-- ================================================================
       IMPORT DIALOG
       ================================================================ -->
  <div class="modal-overlay" id="importModal" style="display:none" role="dialog" aria-label="Import patient data" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <h2 data-i18n="history.importTitle">Import Data</h2>
        <button class="modal-close" onclick="History.closeImportDialog()" aria-label="Close import dialog">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px" data-i18n="history.importDesc">Paste exported JSON data below to import patient records.</p>
        <label for="importTextarea" class="sr-only">JSON data to import</label>
        <textarea id="importTextarea" placeholder="Paste exported JSON data here..." rows="8" class="import-textarea" aria-label="JSON data to import"></textarea>
        <div class="import-actions">
          <label class="btn btn-sm btn-secondary import-file-label" tabindex="0" role="button" aria-label="Choose file to import">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align:-2px;margin-right:4px">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>
            </svg>
            <span>Choose File</span>
            <input type="file" id="importFileInput" accept=".json,application/json" onchange="History.onFileSelected(event)" style="display:none">
          </label>
          <button class="btn btn-sm btn-primary" onclick="History.doImport()" aria-label="Import data">
            <span data-i18n="history.importAction">Import</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       CONFIRM DELETE DIALOG
       ================================================================ -->
  <div class="modal-overlay" id="confirmModal" style="display:none" role="alertdialog" aria-label="Confirm action" aria-modal="true">
    <div class="modal modal-confirm">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm</h2>
        <button class="modal-close" onclick="History.closeConfirm()" aria-label="Cancel">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" style="font-size:14px;color:var(--text-muted);margin-bottom:16px"></p>
        <div style="display:flex;gap:10px">
          <button class="btn btn-sm btn-secondary" onclick="History.closeConfirm()" style="flex:1" data-i18n="history.cancel">Cancel</button>
          <button class="btn btn-sm" id="confirmAction" onclick="History.executeConfirm()" style="flex:1;background:var(--danger);color:white" data-i18n="history.delete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       NOTES EDITOR DIALOG
       ================================================================ -->
  <div class="modal-overlay" id="notesModal" style="display:none" role="dialog" aria-label="Edit clinical notes" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <h2 data-i18n="history.notesTitle">Clinical Notes</h2>
        <button class="modal-close" onclick="History.closeNotesEditor()" aria-label="Close notes editor">&times;</button>
      </div>
      <div class="modal-body">
        <label for="notesTextarea" class="sr-only">Clinical notes</label>
        <textarea id="notesTextarea" placeholder="Enter clinical observations..." rows="6" class="import-textarea" aria-label="Clinical notes"></textarea>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn btn-sm btn-secondary" onclick="History.closeNotesEditor()" style="flex:1" data-i18n="history.cancel">Cancel</button>
          <button class="btn btn-sm btn-primary" onclick="History.saveNotes()" style="flex:1" data-i18n="history.saveNotes">Save Notes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================================================================
       SCRIPTS
       ================================================================ -->
  <script src="js/i18n.js"></script>
  <script src="js/patient-store.js"></script>
  <script src="js/report.js"></script>
  <script src="js/app.js"></script>
  <script src="js/history.js"></script>

</body>
</html>
