<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PupilCheck - AI Anisocoria Assessment</title>
  <meta name="theme-color" content="#e94560">
  <meta name="description" content="AI-powered pupil assessment tool for clinical anisocoria detection">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PupilCheck">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/components.css">
  <style>
    /* Hub-page-specific layout helpers */
    .hub-card-content {
      flex: 1;
      min-width: 0;
    }
    .hub-card-primary {
      border-color: rgba(233, 69, 96, 0.35);
      background: linear-gradient(135deg, var(--surface) 0%, rgba(233, 69, 96, 0.08) 100%);
    }
    .hub-card-primary:hover {
      border-color: var(--primary);
    }
    .mode-card.active {
      border-color: var(--primary);
      color: var(--text);
      background: rgba(233, 69, 96, 0.1);
    }
    .ml-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 20px;
      min-height: 20px;
    }
    .last-measurement-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 16px;
    }
    /* Modal overlay using inline display toggling */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 300;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal {
      position: relative;
      background: var(--surface-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow-md);
      animation: fadeIn 0.25s ease;
      max-height: 85vh;
      overflow-y: auto;
      display: block;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px 12px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .modal-header h2 {
      font-size: 18px;
      font-weight: 700;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background var(--transition-fast), color var(--transition-fast);
      line-height: 1;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
    }
    .modal-close:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    .modal-body {
      padding: 16px 20px 20px;
    }
    .settings-select {
      background: var(--bg);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      width: 100%;
      font-size: 14px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }
    .settings-select:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    .settings-toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
    }
    /* High contrast class (toggled via JS) */
    .high-contrast {
      --bg: #000000;
      --surface: #111111;
      --surface2: #1a1a1a;
      --surface-elevated: #1a1a1a;
      --text: #ffffff;
      --text-muted: #cccccc;
      --primary: #ff5577;
      --primary-light: #ff8899;
      --success: #44ff88;
      --warning: #ffcc00;
      --danger: #ff4444;
      --info: #88bbff;
      --border-subtle: rgba(255, 255, 255, 0.25);
    }
  </style>
</head>
<body>

  <!-- ================================================================
       HEADER
       ================================================================ -->
  <header class="header" role="banner">
    <h1>PupilCheck</h1>
    <div class="subtitle" data-i18n="tagline">Clinical Pupil Assessment Tool</div>
  </header>

  <!-- ================================================================
       MAIN CONTENT
       ================================================================ -->
  <main class="screen active" role="main" aria-label="PupilCheck Hub">

    <!-- App Branding -->
    <div style="text-align:center;margin:24px 0 8px">
      <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
        <ellipse cx="32" cy="32" rx="28" ry="20" stroke="var(--primary)" stroke-width="2.5" fill="none"/>
        <circle cx="32" cy="32" r="12" stroke="var(--info)" stroke-width="2" fill="rgba(112,161,255,0.12)"/>
        <circle cx="32" cy="32" r="5.5" fill="var(--text)"/>
        <circle cx="34" cy="30" r="1.8" fill="var(--bg)"/>
      </svg>
    </div>
    <h2 class="welcome-title">PupilCheck v2.0</h2>
    <p class="welcome-desc" data-i18n="hub.tagline">AI-powered clinical pupil assessment for anisocoria detection</p>

    <!-- AI Status Indicator -->
    <div class="ml-status" id="mlStatus" aria-live="polite">
      <span class="status-dot gray" aria-hidden="true"></span>
      <span data-i18n="status.initializing">Initializing...</span>
    </div>

    <!-- New Measurement Card (Primary Action) -->
    <a href="measure.html" class="hub-card hub-card-primary" aria-label="Start new measurement">
      <div class="hub-card-icon" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
      </div>
      <div class="hub-card-content">
        <div class="hub-card-title" data-i18n="hub.newMeasurement">New Measurement</div>
        <div class="hub-card-desc" data-i18n="hub.newMeasurementDesc">Capture and analyze pupil size and reactivity</div>
      </div>
      <div class="hub-card-arrow" aria-hidden="true">&#8594;</div>
    </a>

    <!-- Patient History Card -->
    <a href="history.html" class="hub-card" aria-label="View patient history">
      <div class="hub-card-icon" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20V10"/>
          <path d="M18 20V4"/>
          <path d="M6 20v-4"/>
        </svg>
      </div>
      <div class="hub-card-content">
        <div class="hub-card-title" data-i18n="hub.history">History</div>
        <div class="hub-card-desc" data-i18n="hub.historyDesc">View past measurements and trends</div>
      </div>
      <span class="badge" id="patientBadge" style="display:none" aria-label="Patient count">0</span>
      <div class="hub-card-arrow" aria-hidden="true">&#8594;</div>
    </a>

    <!-- Last Measurement Quick View -->
    <div class="last-measurement-card" id="lastMeasurement" style="display:none" aria-label="Most recent measurement">
      <!-- Populated dynamically by updateLastMeasurement() -->
    </div>

    <!-- Mode Selection -->
    <div style="display:flex;gap:12px;margin-bottom:16px" role="radiogroup" aria-label="Measurement mode">
      <div class="mode-card active" id="modeSizeCard" onclick="selectMode('size')" role="radio" aria-checked="true" tabindex="0" aria-label="Size only mode">
        <div class="mode-card-title" data-i18n="hub.sizeOnly">Size Only</div>
        <div class="mode-card-desc" data-i18n="hub.sizeOnlyDesc">Quick pupil size comparison</div>
      </div>
      <div class="mode-card" id="modeReactivityCard" onclick="selectMode('reactivity')" role="radio" aria-checked="false" tabindex="0" aria-label="Reactivity mode">
        <div class="mode-card-title" data-i18n="hub.reactivity">+ Reactivity</div>
        <div class="mode-card-desc" data-i18n="hub.reactivityDesc">Full RAPD screening</div>
      </div>
    </div>

    <!-- Settings Button -->
    <button class="btn btn-secondary" onclick="openSettings()" style="margin-bottom:12px" aria-haspopup="dialog">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px" aria-hidden="true">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
      <span data-i18n="settings.title">Settings</span>
    </button>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" style="display:none" role="dialog" aria-label="Settings" aria-modal="true">
      <div class="modal">
        <div class="modal-header">
          <h2 data-i18n="settings.title">Settings</h2>
          <button class="modal-close" onclick="closeSettings()" aria-label="Close settings">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Language -->
          <div class="slider-group">
            <label for="langSelect" data-i18n="settings.language">Language</label>
            <select id="langSelect" onchange="changeLanguage(this.value)" class="settings-select" aria-label="Select language">
              <option value="en">English</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
          <!-- Iris Reference Diameter -->
          <div class="slider-group">
            <label for="irisRefSlider">
              <span data-i18n="settings.irisRef">Iris Reference</span>
              <span id="irisRefValue">11.7 mm</span>
            </label>
            <input type="range" id="irisRefSlider" min="10.0" max="13.0" step="0.1" value="11.7" oninput="updateIrisRef()" aria-label="Iris reference diameter in millimeters">
          </div>
          <!-- High Contrast -->
          <div class="settings-toggle-row">
            <label for="highContrastToggle" data-i18n="settings.highContrast">High Contrast</label>
            <input type="checkbox" id="highContrastToggle" onchange="toggleHighContrast()" aria-label="Toggle high contrast mode">
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer" role="contentinfo">
      <div class="disclaimer" data-i18n="general.disclaimer"><strong>Disclaimer:</strong> This tool is for clinical screening assistance only. It does not replace professional ophthalmological evaluation. Always correlate findings with a complete clinical assessment.</div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-muted)">PupilCheck v2.0</div>
    </footer>

  </main>

  <!-- ================================================================
       SCRIPTS
       ================================================================ -->
  <script src="js/i18n.js"></script>
  <script src="js/patient-store.js"></script>
  <script src="js/detection-ml.js"></script>
  <script src="js/detection-cloud.js"></script>
  <script src="js/app.js"></script>

  <script>
    // ---------------------------------------------------------------
    // Mode selection
    // ---------------------------------------------------------------
    let selectedMode = localStorage.getItem('pupilcheck_mode') || 'size';

    function selectMode(mode) {
      selectedMode = mode;
      localStorage.setItem('pupilcheck_mode', mode);
      document.getElementById('modeSizeCard').classList.toggle('active', mode === 'size');
      document.getElementById('modeReactivityCard').classList.toggle('active', mode === 'reactivity');
      document.getElementById('modeSizeCard').setAttribute('aria-checked', mode === 'size' ? 'true' : 'false');
      document.getElementById('modeReactivityCard').setAttribute('aria-checked', mode === 'reactivity' ? 'true' : 'false');
    }

    // ---------------------------------------------------------------
    // Settings modal
    // ---------------------------------------------------------------
    function openSettings() {
      document.getElementById('settingsModal').style.display = 'flex';
      // Trap focus inside modal
      document.getElementById('settingsModal').querySelector('.modal-close').focus();
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function changeLanguage(locale) {
      if (typeof i18n !== 'undefined' && i18n.setLocale) {
        i18n.setLocale(locale);
      }
    }

    function updateIrisRef() {
      var val = parseFloat(document.getElementById('irisRefSlider').value);
      document.getElementById('irisRefValue').textContent = val.toFixed(1) + ' mm';
      if (typeof App !== 'undefined' && App.setIrisRefMm) {
        App.setIrisRefMm(val);
      }
    }

    function toggleHighContrast() {
      var checked = document.getElementById('highContrastToggle').checked;
      if (typeof App !== 'undefined' && App.setHighContrast) {
        App.setHighContrast(checked);
      } else {
        document.documentElement.classList.toggle('high-contrast', checked);
      }
    }

    // ---------------------------------------------------------------
    // Last measurement quick view
    // ---------------------------------------------------------------
    function updateLastMeasurement() {
      var last = (typeof patientStore !== 'undefined') ? patientStore.getLastMeasurement() : null;
      var el = document.getElementById('lastMeasurement');
      if (!last) {
        el.style.display = 'none';
        return;
      }
      el.style.display = 'block';

      var assessClass = (typeof App !== 'undefined' && App.assessmentClass)
        ? App.assessmentClass(last.assessment && last.assessment.diffMm ? last.assessment.diffMm : 0)
        : 'normal';
      var formattedDate = (typeof App !== 'undefined' && App.formatDateTime)
        ? App.formatDateTime(last.timestamp)
        : new Date(last.timestamp).toLocaleString();
      var assessTitle = (last.assessment && last.assessment.title) ? last.assessment.title : '';
      var leftRatio = (last.left && last.left.ratio != null) ? last.left.ratio.toFixed(3) : '-';
      var rightRatio = (last.right && last.right.ratio != null) ? last.right.ratio.toFixed(3) : '-';
      var diffStr = (last.assessment && last.assessment.diffMm)
        ? ' | Diff: ~' + last.assessment.diffMm.toFixed(1) + ' mm'
        : '';

      el.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">' +
          '<span style="font-size:12px;color:var(--text-muted)">' + formattedDate + '</span>' +
          '<span class="badge badge-' + assessClass + '">' + assessTitle + '</span>' +
        '</div>' +
        '<div style="font-size:13px">' + (last.patientLabel || '') + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">' +
          'L: ' + leftRatio + ' | R: ' + rightRatio + diffStr +
        '</div>';
    }

    // ---------------------------------------------------------------
    // Patient badge
    // ---------------------------------------------------------------
    function updatePatientBadge() {
      var count = (typeof patientStore !== 'undefined') ? patientStore.getPatientCount() : 0;
      var badge = document.getElementById('patientBadge');
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-flex';
      } else {
        badge.style.display = 'none';
      }
    }

    // ---------------------------------------------------------------
    // Close modal on backdrop click or Escape key
    // ---------------------------------------------------------------
    document.getElementById('settingsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeSettings();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        var modal = document.getElementById('settingsModal');
        if (modal.style.display !== 'none') {
          closeSettings();
        }
      }
    });

    // ---------------------------------------------------------------
    // Keyboard support for mode cards
    // ---------------------------------------------------------------
    document.getElementById('modeSizeCard').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectMode('size');
      }
    });
    document.getElementById('modeReactivityCard').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectMode('reactivity');
      }
    });

    // ---------------------------------------------------------------
    // Initialize on DOMContentLoaded
    // ---------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', async function() {
      // Load high contrast setting
      if (typeof patientStore !== 'undefined') {
        var settings = patientStore.getSettings();
        if (settings.highContrast) {
          document.getElementById('highContrastToggle').checked = true;
          document.documentElement.classList.add('high-contrast');
        }
      }

      // Load iris reference setting
      if (typeof App !== 'undefined' && App.getIrisRefMm) {
        var irisRef = App.getIrisRefMm();
        document.getElementById('irisRefSlider').value = irisRef;
        document.getElementById('irisRefValue').textContent = irisRef.toFixed(1) + ' mm';
      }

      // Restore saved language
      var savedLang = localStorage.getItem('pupilcheck_lang') || 'en';
      document.getElementById('langSelect').value = savedLang;

      // Restore mode selection
      selectMode(selectedMode);

      // Init i18n
      if (typeof i18n !== 'undefined' && i18n.init) {
        await i18n.init();
      }

      // Update UI elements
      updateLastMeasurement();
      updatePatientBadge();

      // Init ML (non-blocking)
      if (typeof App !== 'undefined' && App.initML) {
        App.initML();
      }

      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then(function(reg) { console.log('SW registered:', reg.scope); })
          .catch(function(err) { console.log('SW registration failed:', err); });
      }
    });
  </script>

</body>
</html>
